local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local Camera = Workspace.CurrentCamera

-- ====== CLEANUP OLD UI ======
for _, uiName in ipairs({"AKB_MasterUI", "AKB_CombinedUI", "FantasyFarmGUI", "PlayerTeleportGui"}) do
    pcall(function()
        local ui = PlayerGui:FindFirstChild(uiName)
        if ui then ui:Destroy() end
    end)
end

-- ====== VARIABLES ======
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AKB_MasterUI"
screenGui.ResetOnSpawn = false
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
screenGui.Parent = PlayerGui

local fantasyColors = {
    Background = Color3.fromRGB(25, 20, 40),
    Primary = Color3.fromRGB(45, 35, 70),
    Secondary = Color3.fromRGB(0, 150, 160),
    Highlight = Color3.fromRGB(255, 220, 100),
    Text = Color3.fromRGB(240, 230, 255),
    TextGold = Color3.fromRGB(255, 235, 170),
    AimTarget = Color3.fromRGB(255, 50, 50),
    Ignore = Color3.fromRGB(255, 100, 100),
    AKBBlue = Color3.fromRGB(0, 255, 255)
}

-- ====== AIM CONFIG (ตั้งค่าการเล็ง) ======
local aimAssistEnabled = false
local isAiming = false -- สถานะกดคลิกขวาค้าง
local aimTarget = nil 
local AIM_DISTANCE = 5000 
local FOV_RADIUS = 300 -- รัศมีวงกลมในการล็อค (พิกเซล)
local ignoredPlayers = {}

local AIM_PART = "Head" 
local AIM_OFFSET = Vector3.new(0, 0, 0) 

-- ====== ESP CONFIG (ตั้งค่า ESP) ======
local espEnabled = false 

-- ====== HELPER FUNCTION: RESOLVE CHARACTER ======
local function resolveCharacter(target)
    if not target then return nil end
    if target:IsA("Model") then
        return target
    elseif target:IsA("Player") then
        if target.Character and target.Character.Parent then return target.Character end
        return Workspace:FindFirstChild(target.Name)
    end
    return nil
end

local function getCharacterParts(character)
    if not character then return nil, nil end
    local root = character:FindFirstChild("HumanoidRootPart") or 
                 character:FindFirstChild("Torso") or 
                 character:FindFirstChild("UpperTorso") or 
                 character.PrimaryPart
    local head = character:FindFirstChild(AIM_PART) or root
    return root, head
end

-- ====== INTRO SEQUENCE (AKB) ======
task.spawn(function()
    local introLabel = Instance.new("TextLabel")
    introLabel.Name = "AKB_Intro"
    introLabel.Size = UDim2.new(1, 0, 1, 0)
    introLabel.Position = UDim2.new(0, 0, 0, -20)
    introLabel.BackgroundTransparency = 1
    introLabel.Text = "AKB"
    introLabel.TextColor3 = fantasyColors.AKBBlue
    introLabel.TextSize = 100
    introLabel.Font = Enum.Font.GothamBold
    introLabel.TextTransparency = 0
    introLabel.Parent = screenGui
    
    local stroke = Instance.new("UIStroke")
    stroke.Parent = introLabel
    stroke.Thickness = 3
    stroke.Transparency = 0

    local versionLabel = Instance.new("TextLabel")
    versionLabel.Name = "AKB_Version"
    versionLabel.Size = UDim2.new(1, 0, 0, 30)
    versionLabel.Position = UDim2.new(0, 0, 0.5, 40)
    versionLabel.BackgroundTransparency = 1
    versionLabel.Text = "Version: ESP Link + Continuous Lock" -- แสดงเวอร์ชั่นใหม่
    versionLabel.TextColor3 = fantasyColors.Highlight
    versionLabel.TextSize = 24
    versionLabel.Font = Enum.Font.Gotham
    versionLabel.TextTransparency = 0
    versionLabel.Parent = screenGui
    
    task.wait(2)
    local tweenInfo = TweenInfo.new(1, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local tween = TweenService:Create(introLabel, tweenInfo, {TextTransparency = 1})
    local strokeTween = TweenService:Create(stroke, tweenInfo, {Transparency = 1})
    local versionTween = TweenService:Create(versionLabel, tweenInfo, {TextTransparency = 1})
    
    tween:Play()
    strokeTween:Play()
    versionTween:Play()
    
    tween.Completed:Connect(function()
        introLabel:Destroy()
        versionLabel:Destroy()
    end)
end)

-- ====== OFFSET ADJUSTER UI ======
local offsetFrame = Instance.new("Frame")
offsetFrame.Name = "OffsetAdjuster"
offsetFrame.Size = UDim2.new(0, 200, 0, 160)
offsetFrame.Position = UDim2.new(0, 10, 1, -170) 
offsetFrame.BackgroundColor3 = fantasyColors.Background
offsetFrame.BorderSizePixel = 0
offsetFrame.Visible = true
offsetFrame.Parent = screenGui
Instance.new("UICorner", offsetFrame).CornerRadius = UDim.new(0, 8)
Instance.new("UIStroke", offsetFrame).Color = fantasyColors.AKBBlue

local offsetTitle = Instance.new("TextLabel", offsetFrame)
offsetTitle.Size = UDim2.new(1, 0, 0, 25)
offsetTitle.BackgroundTransparency = 1
offsetTitle.Text = "AIM OFFSET ADJUSTER"
offsetTitle.TextColor3 = fantasyColors.AKBBlue
offsetTitle.Font = Enum.Font.GothamBold
offsetTitle.TextSize = 14

local function createSlider(name, yPos, axisChar, defaultVal)
    local label = Instance.new("TextLabel", offsetFrame)
    label.Size = UDim2.new(1, -10, 0, 15)
    label.Position = UDim2.new(0, 5, 0, yPos)
    label.BackgroundTransparency = 1
    label.Text = axisChar .. ": " .. defaultVal
    label.TextColor3 = fantasyColors.Text
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Font = Enum.Font.Code
    label.TextSize = 12

    local sliderBg = Instance.new("Frame", offsetFrame)
    sliderBg.Size = UDim2.new(1, -20, 0, 6)
    sliderBg.Position = UDim2.new(0, 10, 0, yPos + 20)
    sliderBg.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
    Instance.new("UICorner", sliderBg).CornerRadius = UDim.new(1, 0)

    local sliderBtn = Instance.new("TextButton", sliderBg)
    sliderBtn.Size = UDim2.new(0, 12, 0, 12)
    sliderBtn.AnchorPoint = Vector2.new(0.5, 0.5)
    sliderBtn.Position = UDim2.new(0.5, 0, 0.5, 0)
    sliderBtn.BackgroundColor3 = fantasyColors.AKBBlue
    sliderBtn.Text = ""
    Instance.new("UICorner", sliderBtn).CornerRadius = UDim.new(1, 0)

    local isDragging = false
    local minVal, maxVal = -5, 5

    sliderBtn.MouseButton1Down:Connect(function() isDragging = true end)
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then isDragging = false end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if isDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local mousePos = UserInputService:GetMouseLocation().X
            local framePos = sliderBg.AbsolutePosition.X
            local frameSize = sliderBg.AbsoluteSize.X
            local relativePos = math.clamp((mousePos - framePos) / frameSize, 0, 1)
            sliderBtn.Position = UDim2.new(relativePos, 0, 0.5, 0)
            local actualValue = minVal + (relativePos * (maxVal - minVal))
            actualValue = math.floor(actualValue * 10) / 10
            label.Text = axisChar .. ": " .. actualValue
            
            local currentX, currentY, currentZ = AIM_OFFSET.X, AIM_OFFSET.Y, AIM_OFFSET.Z
            if axisChar == "X" then currentX = actualValue
            elseif axisChar == "Y" then currentY = actualValue
            elseif axisChar == "Z" then currentZ = actualValue end
            AIM_OFFSET = Vector3.new(currentX, currentY, currentZ)
        end
    end)
    
    local startAlpha = (defaultVal - minVal) / (maxVal - minVal)
    sliderBtn.Position = UDim2.new(startAlpha, 0, 0.5, 0)
end

createSlider("SliderX", 30, "X", 0)
createSlider("SliderY", 70, "Y", 0)
createSlider("SliderZ", 110, "Z", 0)

-- ====== VISUALS (HEAD MARKER & FOV) ======
local headMarker = Instance.new("BillboardGui")
headMarker.Name = "HeadMarker"
headMarker.Adornee = nil
headMarker.Size = UDim2.new(0, 10, 0, 10)
headMarker.AlwaysOnTop = true
headMarker.Enabled = false
headMarker.Parent = screenGui

local headDot = Instance.new("Frame", headMarker)
headDot.Size = UDim2.new(1, 0, 1, 0)
headDot.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
headDot.BorderSizePixel = 0
Instance.new("UICorner", headDot).CornerRadius = UDim.new(1, 0)

-- FOV Circle
local fovCircle = Instance.new("Frame")
fovCircle.Name = "FOVCircle"
fovCircle.Size = UDim2.new(0, FOV_RADIUS * 2, 0, FOV_RADIUS * 2)
fovCircle.Position = UDim2.new(0.5, 0, 0.5, 0)
fovCircle.AnchorPoint = Vector2.new(0.5, 0.5)
fovCircle.BackgroundColor3 = fantasyColors.Text
fovCircle.BackgroundTransparency = 1
fovCircle.Visible = false
fovCircle.Parent = screenGui

local fovStroke = Instance.new("UIStroke")
fovStroke.Parent = fovCircle
fovStroke.Color = Color3.fromRGB(255, 255, 255)
fovStroke.Thickness = 1
fovStroke.Transparency = 0.5
Instance.new("UICorner", fovCircle).CornerRadius = UDim.new(1, 0)

-- ====== CROSSHAIR UI ======
local crosshairFrame = Instance.new("Frame")
crosshairFrame.Name = "Crosshair"
crosshairFrame.Size = UDim2.new(0, 6, 0, 6)
crosshairFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
crosshairFrame.AnchorPoint = Vector2.new(0.5, 0.5)
crosshairFrame.BackgroundColor3 = fantasyColors.AimTarget
crosshairFrame.BorderSizePixel = 0
crosshairFrame.Visible = false
crosshairFrame.Parent = screenGui
Instance.new("UICorner", crosshairFrame).CornerRadius = UDim.new(1, 0)

-- ====== PLAYER LIST UI ======
local playerListFrame = Instance.new("Frame")
playerListFrame.Name = "PlayerListFrame"
playerListFrame.Size = UDim2.new(0, 220, 0, 300)
playerListFrame.Position = UDim2.new(0, 10, 0.5, -150)
playerListFrame.BackgroundColor3 = fantasyColors.Background
playerListFrame.BorderSizePixel = 0
playerListFrame.Visible = false
playerListFrame.Parent = screenGui
Instance.new("UICorner", playerListFrame).CornerRadius = UDim.new(0, 8)
Instance.new("UIStroke", playerListFrame).Color = fantasyColors.Highlight

local listTitle = Instance.new("TextLabel", playerListFrame)
listTitle.Size = UDim2.new(1, 0, 0, 30)
listTitle.BackgroundColor3 = fantasyColors.Primary
listTitle.Text = "รายชื่อผู้เล่น (5000ม.)" 
listTitle.TextColor3 = fantasyColors.TextGold
listTitle.Font = Enum.Font.Garamond
listTitle.TextSize = 18
Instance.new("UICorner", listTitle).CornerRadius = UDim.new(0, 8)

local scrollingList = Instance.new("ScrollingFrame", playerListFrame)
scrollingList.Name = "ScrollingList"
scrollingList.Size = UDim2.new(1, -10, 1, -40)
scrollingList.Position = UDim2.new(0, 5, 0, 35)
scrollingList.BackgroundTransparency = 1
scrollingList.CanvasSize = UDim2.new(0, 0, 0, 0)
scrollingList.ScrollBarThickness = 6
scrollingList.Parent = playerListFrame

local listLayout = Instance.new("UIListLayout", scrollingList)
listLayout.SortOrder = Enum.SortOrder.LayoutOrder
listLayout.Padding = UDim.new(0, 5)

listLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    scrollingList.CanvasSize = UDim2.new(0, 0, 0, listLayout.AbsoluteContentSize.Y)
end)

local function refreshPlayerList()
    for _, child in ipairs(scrollingList:GetChildren()) do
        if child:IsA("Frame") then child:Destroy() end
    end
    
    local myChar = resolveCharacter(LocalPlayer)
    local myRoot, _ = getCharacterParts(myChar)
    if not myRoot then return end

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            local targetChar = resolveCharacter(player)
            local targetRoot, _ = getCharacterParts(targetChar)
            
            if targetRoot then
                local dist = (targetRoot.Position - myRoot.Position).Magnitude
                if dist <= AIM_DISTANCE then
                    local entry = Instance.new("Frame")
                    entry.Size = UDim2.new(1, -6, 0, 30)
                    entry.BackgroundColor3 = fantasyColors.Primary
                    entry.Parent = scrollingList
                    Instance.new("UICorner", entry).CornerRadius = UDim.new(0, 4)

                    local nameLabel = Instance.new("TextLabel", entry)
                    nameLabel.Size = UDim2.new(0, 140, 1, 0)
                    nameLabel.Position = UDim2.new(0, 5, 0, 0)
                    nameLabel.BackgroundTransparency = 1
                    nameLabel.Text = player.Name .. "\n(" .. math.floor(dist) .. "m)"
                    nameLabel.TextColor3 = fantasyColors.Text
                    nameLabel.TextXAlignment = Enum.TextXAlignment.Left
                    nameLabel.TextSize = 12

                    local ignoreBtn = Instance.new("TextButton", entry)
                    ignoreBtn.Size = UDim2.new(0, 24, 0, 24)
                    ignoreBtn.Position = UDim2.new(1, -28, 0, 3)
                    ignoreBtn.BackgroundColor3 = ignoredPlayers[player] and fantasyColors.Ignore or fantasyColors.Secondary
                    ignoreBtn.Text = ignoredPlayers[player] and "✓" or ""
                    ignoreBtn.TextColor3 = Color3.new(1,1,1)
                    ignoreBtn.Font = Enum.Font.GothamBold
                    Instance.new("UICorner", ignoreBtn).CornerRadius = UDim.new(0, 4)
                    
                    ignoreBtn.MouseButton1Click:Connect(function()
                        if ignoredPlayers[player] then
                            ignoredPlayers[player] = nil
                            ignoreBtn.BackgroundColor3 = fantasyColors.Secondary
                            ignoreBtn.Text = ""
                        else
                            ignoredPlayers[player] = true
                            ignoreBtn.BackgroundColor3 = fantasyColors.Ignore
                            ignoreBtn.Text = "✓"
                        end
                    end)
                end
            end
        end
    end
end

task.spawn(function()
    while true do
        if playerListFrame.Visible then refreshPlayerList() end
        task.wait(1)
    end
end)

-- ====== ESP MANAGER SYSTEM ======
local function applyESP(character, player)
    if not character then return end
    
    local oldHl = character:FindFirstChild("AKB_Highlight")
    if oldHl then oldHl:Destroy() end
    
    local head = character:FindFirstChild("Head")
    if head then
        local oldTag = head:FindFirstChild("AKB_NameTag")
        if oldTag then oldTag:Destroy() end
    end
    
    if not espEnabled then return end

    local hl = Instance.new("Highlight")
    hl.Name = "AKB_Highlight"
    hl.FillColor = fantasyColors.AKBBlue 
    hl.OutlineColor = Color3.new(1, 1, 1) 
    hl.FillTransparency = 0.5 
    hl.OutlineTransparency = 0
    hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    hl.Parent = character

    if head then
        local bg = Instance.new("BillboardGui")
        bg.Name = "AKB_NameTag"
        bg.Adornee = head
        bg.Size = UDim2.new(0, 200, 0, 50)
        bg.StudsOffset = Vector3.new(0, 3.5, 0)
        bg.AlwaysOnTop = true
        bg.Parent = head
        
        local text = Instance.new("TextLabel", bg)
        text.Size = UDim2.new(1, 0, 1, 0)
        text.BackgroundTransparency = 1
        text.Text = player.Name
        text.TextColor3 = fantasyColors.AKBBlue
        text.TextStrokeTransparency = 0
        text.Font = Enum.Font.GothamBold
        text.TextSize = 14
    end
end

local function onCharacterAdded(player, char)
    task.wait(0.5)
    if char and char.Parent then applyESP(char, player) end
end

local function setupPlayer(player)
    if player == LocalPlayer then return end
    if player.Character then onCharacterAdded(player, player.Character) end
    player.CharacterAdded:Connect(function(char) onCharacterAdded(player, char) end)
end

for _, p in ipairs(Players:GetPlayers()) do setupPlayer(p) end
Players.PlayerAdded:Connect(setupPlayer)

task.spawn(function()
    while true do
        if espEnabled then
            for _, player in ipairs(Players:GetPlayers()) do
                if player ~= LocalPlayer then
                    local char = resolveCharacter(player)
                    if char and char.Parent then
                        if not char:FindFirstChild("AKB_Highlight") then applyESP(char, player) end
                    end
                end
            end
        else
            for _, player in ipairs(Players:GetPlayers()) do
                local char = resolveCharacter(player)
                if char then
                    if char:FindFirstChild("AKB_Highlight") then char.AKB_Highlight:Destroy() end
                    if char:FindFirstChild("Head") and char.Head:FindFirstChild("AKB_NameTag") then char.Head.AKB_NameTag:Destroy() end
                end
            end
        end
        task.wait(1)
    end
end)

-- ====== FREE CAM VARIABLES ======
local camera = Workspace.CurrentCamera
local isFreeCamActive = false
local mouseSensitivity = 0.05
local moveSpeed = 50
local shiftSpeedMultiplier = 5
local currentCamPosition = Vector3.new() 
local currentYaw, currentPitch = 0, 0
local originalWalkSpeed, originalJumpHeight = 16, 7.2
local dummyCharacter = nil

-- ====== FIND BEST TARGET (FOV BASED) ======
local function findBestTargetInFOV()
    local bestTarget = nil
    local bestScore = math.huge -- ใช้คะแนน (ระยะห่างจากเป้า) ยิ่งน้อยยิ่งดี
    local screenCenter = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and not ignoredPlayers[player] then
            local char = resolveCharacter(player)
            local root, head = getCharacterParts(char)

            if root and head then
                local screenPos, onScreen = camera:WorldToViewportPoint(head.Position)
                
                -- เช็ค 1: ต้องอยู่หน้ากล้อง (Z > 0)
                if screenPos.Z > 0 then
                    local distToCenter = (Vector2.new(screenPos.X, screenPos.Y) - screenCenter).Magnitude
                    
                    -- เช็ค 2: ต้องอยู่ในวง FOV
                    if distToCenter <= FOV_RADIUS then
                        -- เช็ค 3: ระยะทางในเกมต้องไม่ไกลเกิน
                        local worldDist = (root.Position - camera.CFrame.Position).Magnitude
                        if worldDist <= AIM_DISTANCE then
                            if distToCenter < bestScore then
                                bestScore = distToCenter
                                bestTarget = char
                            end
                        end
                    end
                end
            end
        end
    end
    return bestTarget
end

local function updateFreeCam(deltaTime)
    if not isFreeCamActive then return end
    
    local char = LocalPlayer.Character
    local humanoid = char and char:FindFirstChildOfClass("Humanoid")
    if humanoid then
        humanoid.WalkSpeed = 0
        humanoid.JumpHeight = 0
    end
    
    if UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton2) and not aimAssistEnabled then 
        UserInputService.MouseBehavior = Enum.MouseBehavior.LockCenter
        local delta = UserInputService:GetMouseDelta()
        currentYaw = currentYaw - delta.X * mouseSensitivity
        currentPitch = currentPitch - delta.Y * mouseSensitivity
        currentPitch = math.clamp(currentPitch, -math.pi/2.01, math.pi/2.01) 
    else
        UserInputService.MouseBehavior = Enum.MouseBehavior.Default
    end
    
    local rotationCFrame = CFrame.Angles(0, currentYaw, 0) * CFrame.Angles(currentPitch, 0, 0)
    local moveVector = Vector3.new(0, 0, 0)
    if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveVector += Vector3.new(0, 0, -1) end
    if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveVector += Vector3.new(0, 0, 1) end
    if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveVector += Vector3.new(-1, 0, 0) end
    if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveVector += Vector3.new(1, 0, 0) end
    if UserInputService:IsKeyDown(Enum.KeyCode.E) or UserInputService:IsKeyDown(Enum.KeyCode.Space) then moveVector += Vector3.new(0, 1, 0) end
    if UserInputService:IsKeyDown(Enum.KeyCode.Q) then moveVector += Vector3.new(0, -1, 0) end
    
    local currentSpeed = moveSpeed
    if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then currentSpeed = currentSpeed * shiftSpeedMultiplier end
    if moveVector.Magnitude > 0 then moveVector = moveVector.Unit end
    
    local move = (rotationCFrame.LookVector * -moveVector.Z + rotationCFrame.RightVector * moveVector.X + Vector3.yAxis * moveVector.Y) * currentSpeed * deltaTime
    currentCamPosition = currentCamPosition + move
    camera.CFrame = CFrame.new(currentCamPosition) * rotationCFrame
end

local function disableFreeCam()
    isFreeCamActive = false
    RunService:UnbindFromRenderStep("FreeCamUpdate")
    camera.CameraType = Enum.CameraType.Custom
    local char = LocalPlayer.Character
    local humanoid = char and char:FindFirstChildOfClass("Humanoid")
    if humanoid then
        humanoid.WalkSpeed = originalWalkSpeed
        humanoid.JumpHeight = originalJumpHeight
        camera.CameraSubject = humanoid
    end
    UserInputService.MouseBehavior = Enum.MouseBehavior.Default
    if dummyCharacter then dummyCharacter:Destroy() dummyCharacter = nil end
end

local function enableFreeCam()
    if aimAssistEnabled then
        aimAssistEnabled = false
        crosshairFrame.Visible = false
        aimTarget = nil
        fovCircle.Visible = false
    end
    isFreeCamActive = true
    currentCamPosition = camera.CFrame.Position
    local look = camera.CFrame.LookVector
    currentYaw = math.atan2(look.X, -look.Z) 
    currentPitch = math.asin(look.Y) 
    camera.CameraType = Enum.CameraType.Scriptable
    UserInputService.MouseBehavior = Enum.MouseBehavior.Default
    local char = LocalPlayer.Character
    local humanoid = char and char:FindFirstChildOfClass("Humanoid")
    if humanoid then
        originalWalkSpeed = humanoid.WalkSpeed
        originalJumpHeight = humanoid.JumpHeight
        humanoid.WalkSpeed = 0
        humanoid.JumpHeight = 0
    end
    if char then
        pcall(function()
            dummyCharacter = char:Clone()
            dummyCharacter.Name = "FreeCamDummy"
            dummyCharacter:SetPrimaryPartCFrame(char:GetPrimaryPartCFrame())
            dummyCharacter.Parent = Workspace
            for _, part in ipairs(dummyCharacter:GetDescendants()) do
                if part:IsA("BasePart") then part.Anchored = true part.CanCollide = false part.Transparency = 0.7 end
            end
        end)
    end
    RunService:BindToRenderStep("FreeCamUpdate", Enum.RenderPriority.Last.Value, updateFreeCam)
end

local function onTeleportToCam()
    local root = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if root then
        local finalCFrame = CFrame.new(currentCamPosition) * CFrame.Angles(0, currentYaw, 0) * CFrame.Angles(currentPitch, 0, 0)
        root.CFrame = finalCFrame
    end
    disableFreeCam()
end

-- ====== INPUT HANDLING ======
UserInputService.InputBegan:Connect(function(input, processed)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        isAiming = true
        if aimAssistEnabled then
            -- เมื่อเริ่มกด ลองหาทันที 1 ครั้ง
            aimTarget = findBestTargetInFOV()
        end
    end

    if processed then return end 

    if input.KeyCode == Enum.KeyCode.Y then
        aimAssistEnabled = not aimAssistEnabled
        crosshairFrame.Visible = aimAssistEnabled
        fovCircle.Visible = aimAssistEnabled -- เปิด/ปิดวง FOV
        
        if not aimAssistEnabled then
            aimTarget = nil
            headMarker.Enabled = false
        end
    end

    if input.KeyCode == Enum.KeyCode.L then
        espEnabled = not espEnabled
        if espEnabled then
            for _, p in ipairs(Players:GetPlayers()) do
                local c = resolveCharacter(p)
                if c then applyESP(c, p) end
            end
        end
    end

    if input.KeyCode == Enum.KeyCode.U then
        playerListFrame.Visible = not playerListFrame.Visible
        if playerListFrame.Visible then refreshPlayerList() end
    end
    
    if input.KeyCode == Enum.KeyCode.O then offsetFrame.Visible = not offsetFrame.Visible end
    if input.KeyCode == Enum.KeyCode.RightShift then
        if isFreeCamActive then disableFreeCam() else enableFreeCam() end
    end
    if isFreeCamActive and input.KeyCode == Enum.KeyCode.T then onTeleportToCam() end
end)

UserInputService.InputEnded:Connect(function(input, processed)
    if input.UserInputType == Enum.UserInputType.MouseButton2 then
        isAiming = false
        if aimAssistEnabled then
            aimTarget = nil
            crosshairFrame.BackgroundColor3 = fantasyColors.AimTarget
            headMarker.Enabled = false
        end
    end
end)

-- Aim Loop & Continuous Search
local function updateAimLock()
    -- ถ้าเปิด Aimbot และกดคลิกขวาค้างอยู่
    if aimAssistEnabled and isAiming then
        -- ถ้าไม่มีเป้าหมาย หรือเป้าหมายตาย/หายไป ให้หาใหม่เรื่อยๆ (Continuous Search)
        if not aimTarget or not aimTarget.Parent then
            aimTarget = findBestTargetInFOV()
        end

        if aimTarget then
            local _, headPart = getCharacterParts(aimTarget)
            local player = Players:GetPlayerFromCharacter(aimTarget)
            local isIgnored = player and ignoredPlayers[player]
            
            if headPart and not isIgnored then
                crosshairFrame.BackgroundColor3 = Color3.fromRGB(0, 255, 0) -- สีเขียวเมื่อล็อคติด
                local targetPos = headPart.Position + AIM_OFFSET
                camera.CFrame = CFrame.lookAt(camera.CFrame.Position, targetPos)
                headMarker.Adornee = headPart
                headMarker.StudsOffsetWorldSpace = AIM_OFFSET
                headMarker.Enabled = true
            else
                aimTarget = nil -- เป้าหมายไม่ valid ให้เคลียร์ทิ้งแล้วหาใหม่รอบหน้า
                crosshairFrame.BackgroundColor3 = fantasyColors.AimTarget
                headMarker.Enabled = false
            end
        else
            crosshairFrame.BackgroundColor3 = fantasyColors.AimTarget
            headMarker.Enabled = false
        end
    else
        headMarker.Enabled = false
    end
end

RunService:BindToRenderStep("AimLockUpdate", Enum.RenderPriority.Camera.Value + 1, updateAimLock)
